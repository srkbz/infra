#!/usr/bin/env bash
set -euo pipefail

TASK_VERSION="3.38.0"

SRKBZ_INFRA_ROOT="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
export SRKBZ_INFRA_ROOT

LOCK_FILE="$(pwd)/.cache/taskw/lock"

function main {
    ensure-task
    (
        cd "nodes/$(hostname)"
        mkdir -p "$(dirname "${LOCK_FILE}")"
        exec flock "${LOCK_FILE}" "$(task-path)" "$@"
    )
}

function ensure-task {
    if [ ! -f "$(task-path)" ]; then
        sh -c "$(curl --location https://taskfile.dev/install.sh)" \
            -- -d -b "$(dirname "$(task-path)")" "v${TASK_VERSION}"
    fi
}

function task-path {
    printf "%s" "${SRKBZ_INFRA_ROOT}/.cache/task/${TASK_VERSION}/task"
}

main "$@"
