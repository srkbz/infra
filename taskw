#!/usr/bin/env bash
set -euo pipefail

SRKBZ_INFRA_ROOT="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
export SRKBZ_INFRA_ROOT

TASK_VERSION="3.38.0"

function main {
    if [ -f /srv/srkbz/triggers/APPLY ]; then
        rm /srv/srkbz/triggers/APPLY
    fi
    ensure-task
    cd "nodes/$(hostname)"
    exec "$(task-path)" "$@"
}

function ensure-task {
    if [ ! -f "$(task-path)" ]; then
        sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b "$(dirname "$(task-path)")" "v${TASK_VERSION}"
    fi
}

function task-path {
    printf "%s" "${SRKBZ_INFRA_ROOT}/.cache/task/${TASK_VERSION}/task"
}

main "$@"
