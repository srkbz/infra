environment:
  DROPBOX_CACHE: "${CACHE_DIR}/dropbox"
  DROPBOX_PACKAGE_URL_TTL_SECONDS: "86400"

tasks:
  default:
    labels:
      discover: "true"
    requires: [package]

  package:
    requires: [package-url]
    script: |
      set -x
      url="$(cat "$DROPBOX_CACHE/package/URL")"
      url_id="$(cat "$DROPBOX_CACHE/package/URL_ID")"

      rm -rf "$DROPBOX_CACHE/package/${url_id}"
      mkdir -p "$DROPBOX_CACHE/package/${url_id}"
      cd "$DROPBOX_CACHE/package/${url_id}"

      curl --fail --output package.tar.gz "${url}"
      tar -xvzf package.tar.gz
      chown -R "$USER:$USER" .dropbox-dist
    when:
      check_fails: |
        url_id="$(cat "$DROPBOX_CACHE/package/URL_ID")"
        test -d "$DROPBOX_CACHE/package/${url_id}/.dropbox-dist"
  
  package-url:
    script: |
      set -x
      mkdir -p "$DROPBOX_CACHE/package"
      arch="$(uname -m)"
      curl --fail -s -o /dev/null -w '%header{location}' "https://www.dropbox.com/download?plat=lnx.${arch}" > "$DROPBOX_CACHE/package/URL"
      cat "$DROPBOX_CACHE/package/URL" | sha256sum | sed 's/ *-//' > "$DROPBOX_CACHE/package/URL_ID"
    when:
      check_fails: |
        test -f "$DROPBOX_CACHE/package/URL"
        [ $(("$(date -r "$DROPBOX_CACHE/package/URL" "+%s")" + "$DROPBOX_PACKAGE_URL_TTL_SECONDS")) -gt "$(date "+%s")" ]
