environment:
  PORT_REGISTRY: "${EBRO_ROOT}/.state/utils/port-registry"
  PORT_REGISTRY_RANDOM_INITIAL_PORT: "10000"

tasks:
  sync-directories:
    abstract: true
    script: |
      mkdir -p "${SYNC_TO}/"
      rsync --checksum --archive --delete --itemize-changes "${SYNC_FROM}/" "${SYNC_TO}/"
    when:
      check_fails: |
        result="$(rsync --checksum --archive --delete --itemize-changes --dry-run "${SYNC_FROM}/" "${SYNC_TO}/")"
        [ ! -n "$result" ]

  reserve-port:
    abstract: true
    requires: [port-registry]
    script: |
      cd "$PORT_REGISTRY"

      next="$(cat next)"
      echo "$next" > "allocations/${EBRO_TASK_ID}"
      next=$((next+1))
      echo "$next" > next

      if [ -n "${PORT_FILE:-}" ]; then
        cp "allocations/${EBRO_TASK_ID}" "${PORT_FILE}"
      fi
    when:
      check_fails: |
        test -f "${PORT_REGISTRY}/allocations/${EBRO_TASK_ID}"

  port-registry:
    script: |
      mkdir -p "$PORT_REGISTRY"
      cd "$PORT_REGISTRY"

      mkdir -p allocations
      echo "$PORT_REGISTRY_RANDOM_INITIAL_PORT" > next
    when:
      check_fails: |
        test -d "$PORT_REGISTRY"

  reset-port-registry:
    script: rm -rf "$PORT_REGISTRY"
