environment:
  STATE_DIR: "${STATE_DIR}"
  CACHE_DIR: "${CACHE_DIR}"

tasks:
  default:
    required_by: [":discover"]
    requires:
      - state-dir
      - cache-dir

  dir:
    abstract: true
    script: |
      set -x
      mkdir -p "${TARGET_DIR}"
      chmod "${TARGET_DIR_PERM}" "${TARGET_DIR}"
    when:
      check_fails: |
        test -d "${TARGET_DIR}"
        [ "$(stat --format '%a' "${TARGET_DIR}")" == "${TARGET_DIR_PERM}" ]

  state-dir:
    extends: [dir]
    environment:
      TARGET_DIR: "${STATE_DIR}"
      TARGET_DIR_PERM: "700"

  cache-dir:
    extends: [dir]
    environment:
      TARGET_DIR: "${CACHE_DIR}"
      TARGET_DIR_PERM: "700"
