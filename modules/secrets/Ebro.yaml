environment:
  SECRETS_STATE: ${EBRO_ROOT}/.state/secrets
  SECRETS_CACHE: ${EBRO_ROOT}/.cache/secrets

tasks:
  default:
    labels:
      autorequire: "true"
    requires: [secrets-xml]
    script: |
      mkdir -p "${SECRETS_STATE}"
      cd "${SECRETS_STATE}"

      "$EBRO_TASK_WORKING_DIRECTORY/secrets-xml-to-dir.sh" "${SECRETS_CACHE}/secrets.xml"
    when:
      check_fails: test -d "${SECRETS_STATE}"
      output_changes: |
        cat secrets-xml-to-dir.sh
        cat secrets-xml-to-dir.py
        cat "${SECRETS_CACHE}/secrets.xml"

  secrets-xml:
    requires: [dependencies]
    script: |
      . "${EBRO_ROOT}/secrets.env"

      mkdir -p "${SECRETS_CACHE}"
      cd "${SECRETS_CACHE}"

      export SECRETS_URL
      export SECRETS_PASSWORD
      "$EBRO_TASK_WORKING_DIRECTORY/secrets-download-extract-export.sh"
    when:
      output_changes: |
        cat "${EBRO_ROOT}/secrets.env" | sha256sum
        cat secrets-download-extract-export.sh
      check_fails: |
        test -f "${SECRETS_CACHE}/secrets.xml"

  dependencies:
    extends: [":apt:configure"]
    script: echo "unzip keepassxc" > "${APT_PACKAGES_ROOT}/secrets.txt"

  reset:
    script: |
      rm -rf "${SECRETS_STATE}"
      rm -rf "${SECRETS_CACHE}"
