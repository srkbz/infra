environment:
  SECRETS_HOME: ${STATE_DIR}/secrets

tasks:
  default:
    labels:
      autorequire: "true"
    requires: [dependencies]
    script: |
      mkdir -p "${SECRETS_HOME}"
      cd "${SECRETS_HOME}"
      rm -rf *

      . "${EBRO_ROOT}/secrets.env"
      SECRETS_URL="${SECRETS_URL}"
      SECRETS_PASSWORD="${SECRETS_PASSWORD}"

      mkdir -p archive
      (
        cd archive
        curl -Lo "secrets.zip" "${SECRETS_URL}"
        unzip -o "secrets.zip" || true
        echo "${SECRETS_PASSWORD}" | keepassxc-cli export --quiet secrets.kdbx >secrets.xml
      )

      "$EBRO_TASK_WORKING_DIRECTORY/generate-secrets-json.sh" archive/secrets.xml secrets.json
      rm -rf archive

  dependencies:
    extends: [":apt:configure"]
    script: echo "unzip keepassxc" > "${APT_PACKAGES_ROOT}/secrets.txt"

  reset:
    script: |
      rm -rf "${SECRETS_STATE}"
      rm -rf "${SECRETS_CACHE}"
