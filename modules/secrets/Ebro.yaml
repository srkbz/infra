environment:
  SECRETS_HOME: ${STATE_DIR}/secrets

tasks:
  default:
    labels:
      autorequire: "true"
    requires: [archive]
    script: |
      cd "${SECRETS_HOME}"

      . "${EBRO_ROOT}/secrets.env"
      SECRETS_PASSWORD="${SECRETS_PASSWORD}"

      (
        cd archive
        unzip -o "secrets.zip" || true
        echo "${SECRETS_PASSWORD}" | keepassxc-cli export --quiet secrets.kdbx >secrets.xml
      )

      "$EBRO_TASK_WORKING_DIRECTORY/generate-secrets-json.py" archive/secrets.xml secrets.json
    when:
      check_fails: test -f "${SECRETS_HOME}/secrets.json"

  archive:
    requires: [dependencies]
    script: |
      mkdir -p "${SECRETS_HOME}"
      cd "${SECRETS_HOME}"
      rm -rf *

      . "${EBRO_ROOT}/secrets.env"
      SECRETS_URL="${SECRETS_URL}"

      mkdir -p archive
      (
        cd archive
        curl -Lo "secrets.zip" "${SECRETS_URL}"
      )
    when:
      check_fails: test -f "${SECRETS_HOME}/archive/secrets.zip"

  dependencies:
    extends: [":apt:configure"]
    script: echo "unzip keepassxc" > "${APT_PACKAGES_ROOT}/secrets.txt"

  op:
    script: |
      "$EBRO_TASK_WORKING_DIRECTORY/generate-env-op.py"

  reset:
    script: |
      rm -rf "${SECRETS_HOME}"
