version: "3"

tasks:
  default:
    deps: [secrets-download]

  package-unzip:
    cmds:
      - mkdir -p .cache/apt/lock
      - flock .cache/apt/lock apt-get install -y unzip
    status:
      - command -v unzip

  package-keepassxc:
    cmds:
      - mkdir -p .cache/apt/lock
      - flock .cache/apt/lock apt-get install -y keepassxc
    status:
      - command -v keepassxc-cli

  secrets-download:
    deps: [package-unzip, package-keepassxc]
    dotenv:
      - secrets.env
    dir: .cache/secrets/download
    cmds:
      - 'curl -Lo "secrets.zip" "${SECRETS_URL}"'
      - "unzip -o 'secrets.zip'"
      - echo "${SECRETS_PASSWORD}" | keepassxc-cli export --quiet secrets.kdbx > secrets.xml
    status:
      - .cache/secrets/download/secrets.xml
