version: "3"

tasks:
  default:
    deps: [secrets-xml]

  package-unzip:
    cmds:
      - mkdir -p .cache/apt/lock
      - flock .cache/apt/lock apt-get install -y unzip
    status:
      - command -v unzip

  package-keepassxc:
    cmds:
      - mkdir -p .cache/apt/lock
      - flock .cache/apt/lock apt-get install -y keepassxc
    status:
      - command -v keepassxc-cli

  secrets-xml:
    deps: [package-unzip, package-keepassxc]
    dir: .cache/secrets/download
    dotenv:
      - "{{.USER_WORKING_DIR}}/secrets.env"
    cmds:
      - "{{.TASKFILE_DIR}}/secrets-download-extract-export.sh"
    status:
      - \[ -f '{{.USER_WORKING_DIR}}/.cache/secrets/download/secrets.xml' ]
