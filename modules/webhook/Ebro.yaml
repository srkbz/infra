environment:
  WEBHOOK_CONF_ROOT: ${EBRO_ROOT}/.cache/webhook/conf

tasks:
  default:
    requires: [bin, prepare]
    script: |
      WD="$(pwd)"
      cd "${WEBHOOK_CONF_ROOT}"
      "$WD/write-config.py"
      systemctl restart webhook.service
    when:
      output_changes: |
        cat write-config.py
        cat "${WEBHOOK_CONF_ROOT}/"* || true
      check_fails: test -f /etc/webhook.conf

  bin:
    requires: [":apt:prepare"]
    required_by: [":apt"]
    script: echo webhook > "${EBRO_ROOT}/.cache/apt/packages/webhook.txt"
    when:
      check_fails: test -f "${EBRO_ROOT}/.cache/apt/packages/webhook.txt"
      output_changes: echo webhook

  prepare:
    script: rm -rf "${WEBHOOK_CONF_ROOT}" && mkdir -p "${WEBHOOK_CONF_ROOT}"
    quiet: true

  configure:
    abstract: true
    requires: [prepare]
    required_by: [default]
