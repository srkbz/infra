environment:
  RESTIC_VERSION: "0.17.3"
  RESTIC_ROOT: ${EBRO_ROOT}/.cache/restic

tasks:
  default:
    requires: [install, ":secrets", backup-all-regularly]

  install:
    script: |
      rm -rf "$RESTIC_ROOT"/bin/*
      RESTIC_VARIANT="$(./restic-variant.sh)"
      curl --fail --location --create-dirs --output "$RESTIC_ROOT/bin/restic_${RESTIC_VERSION}_${RESTIC_VARIANT}.bz2" \
        "https://github.com/restic/restic/releases/download/v${RESTIC_VERSION}/restic_${RESTIC_VERSION}_${RESTIC_VARIANT}.bz2"
      (
        cd "$RESTIC_ROOT/bin"
        cat "${EBRO_TASK_WORKING_DIRECTORY}/SHA256SUMS" | grep "${RESTIC_VARIANT}" | sha256sum --check
        bzip2 -d "restic_${RESTIC_VERSION}_${RESTIC_VARIANT}.bz2"
        mv "restic_${RESTIC_VERSION}_${RESTIC_VARIANT}" restic
        chmod +x restic
      )
    when:
      output_changes: echo "${RESTIC_VERSION}" && cat SHA256SUMS
      check_fails: |
        test -f "$RESTIC_ROOT/bin/restic"
        [[ "$("$RESTIC_ROOT/bin/restic" version)" == "restic ${RESTIC_VERSION} "* ]]

  config-dir:
    quiet: true
    script: |
      mkdir -p "${RESTIC_ROOT}/conf"
      rm -rf "${RESTIC_ROOT}/conf"/*

  configure:
    abstract: true
    quiet: true
    requires: [config-dir]
    script: echo "$RESTIC_BACKUP_LOCATION" > "${RESTIC_ROOT}/conf/${RESTIC_BACKUP_NAME}"

  backup-all-regularly:
    extends: [":cron:configure"]
    environment:
      CRON_ENTRY: "0 3 * * * cd '${RESTIC_ROOT}' && '${EBRO_TASK_WORKING_DIRECTORY}/backup-all.sh' '${EBRO_ROOT}/.state/secrets/restic.env'"

  backup-all:
    script: |
      cd "${RESTIC_ROOT}"
      "${EBRO_TASK_WORKING_DIRECTORY}/backup-all.sh" "${EBRO_ROOT}/.state/secrets/restic.env"
