environment:
  RESTIC_VERSION: "0.17.3"
  RESTIC_HOME: ${EBRO_ROOT}/.state/restic
  RESTIC_ROOT: ${EBRO_ROOT}/.cache/restic/bin

tasks:
  default:
    requires: [install]

  install:
    script: |
      rm -rf $RESTIC_ROOT/*
      RESTIC_VARIANT="$(./restic-variant.sh)"
      curl --fail --location --create-dirs --output "$RESTIC_ROOT/restic_${RESTIC_VERSION}_${RESTIC_VARIANT}.bz2" \
        "https://github.com/restic/restic/releases/download/v${RESTIC_VERSION}/restic_${RESTIC_VERSION}_${RESTIC_VARIANT}.bz2"
      (
        cd "$RESTIC_ROOT"
        bzip2 -dk archive.bz2
      )
    when:
      output_changes: echo "${RESTIC_VERSION}" && cat SHA256SUMS
      check_fails: test -f "$RESTIC_ROOT/restic"
