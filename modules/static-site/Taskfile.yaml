version: '3'

tasks:
  default:
    deps: [build, caddy-config]

  build:
    deps: [workdir, ':docker']
    env:
      DOMAIN: '{{.DOMAIN}}'
      REPOSITORY: '{{.REPOSITORY}}'
    cmds:
      - '{{.TASKFILE_DIR}}/build-site.sh'
    status:
      - \[ "$(cat '/srv/srkbz/static-sites/{{.DOMAIN}}/COMMIT')" == '{{.COMMIT}}' ]

  target-commit:
    deps: [workdir, ':docker', target-commit]
    env:
      REPOSITORY: '{{.REPOSITORY}}'
      BRANCH: '{{.BRANCH}}'
    cmds:
      - '{{.TASKFILE_DIR}}/update-target-commit.sh'
    status:
      - \[ -f '/srv/srkbz/static-sites/{{.DOMAIN}}/COMMIT' ]

  caddy-config:
    deps: [':caddy']
    env:
      DOMAIN: '{{.DOMAIN}}'
    cmds:
      - cat {{.TASKFILE_DIR}}/Caddyfile | envsubst > /etc/caddy/conf.d/{{.DOMAIN}}.caddyfile
      - systemctl reload caddy
    sources:
      - '{{.TASKFILE_DIR}}/Caddyfile'

  workdir:
    cmds:
      - mkdir -p /srv/srkbz/static-sites/{{.DOMAIN}}/live
      - mkdir -p /srv/srkbz/static-sites/{{.DOMAIN}}/builds
    status:
      - '[ -d /srv/srkbz/static-sites/{{.DOMAIN}} ]'
