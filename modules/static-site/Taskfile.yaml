version: '3'

tasks:
  default:
    deps: [build, caddy-config]

  build:
    requires:
      vars: [DOMAIN]
    dotenv:
      - static-sites/{{.DOMAIN}}.env
    sources:
      - static-sites/{{.DOMAIN}}.env
    deps: [workdir, ':docker']
    cmds:
      - '{{.TASKFILE_DIR}}/build-site.sh'

  caddy-config:
    requires:
      vars: [DOMAIN]
    dotenv:
      - static-sites/{{.DOMAIN}}.env
    deps: [':caddy']
    cmds:
      - cat {{.TASKFILE_DIR}}/Caddyfile | envsubst > /etc/caddy/conf.d/{{.DOMAIN}}.caddyfile
      - systemctl reload caddy
    sources:
      - static-sites/{{.DOMAIN}}.env
      - '{{.TASKFILE_DIR}}/Caddyfile'

  workdir:
    requires:
      vars: [DOMAIN]
    cmds:
      - mkdir -p /srv/srkbz/static-sites/{{.DOMAIN}}/live
      - mkdir -p /srv/srkbz/static-sites/{{.DOMAIN}}/builds
    status:
      - '[ -d /srv/srkbz/static-sites/{{.DOMAIN}} ]'
