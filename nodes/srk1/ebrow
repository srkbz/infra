#!/usr/bin/env bash
set -euo pipefail

EBRO_VERSION="0.13.1"
declare -A EBRO_SUMS=(
  ["Linux__aarch64"]="7096f4d9c660a71eefb7ae618bde0d104eabe156b4954e8c4dd8eed23e123caf"
  ["Linux__x86_64"]="28914e6b0a0bbc5cae5cf07f765b179007d5bdeb3760a1269b207b0be74a5c16"
  ["Darwin__arm64"]="7090c6581b0bd8e1c9285a012f51d492f03128860bd81f5b2e64c0be774baf8a"
)

EBRO_BIN=".ebro/bin/${EBRO_VERSION}/ebro"
if [ ! -f "$EBRO_BIN" ] || [ ! -x "$EBRO_BIN" ]; then
  variant="$(uname -s)__$(uname -m)"
  if [ ! "${EBRO_SUMS[$variant]+ok}" ]; then
    echo "The variant $variant is not registered in EBRO_SUMS."
    echo "Add the sha256 checksum to EBRO_SUMS for this variant."
    exit 1
  fi
  curl --fail --location --create-dirs --output "$EBRO_BIN" \
    "https://github.com/sirikon/ebro/releases/download/${EBRO_VERSION}/ebro-${variant}"
  echo "${EBRO_SUMS[$variant]}  ${EBRO_BIN}" | shasum --algorithm 256 --check 2>/dev/null
  chmod +x "$EBRO_BIN"
fi
exec "$EBRO_BIN" "$@"
